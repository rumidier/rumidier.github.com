<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: perl | Meadows of wild horses]]></title>
  <link href="http://rumidier.github.com/blog/categories/perl/atom.xml" rel="self"/>
  <link href="http://rumidier.github.com/"/>
  <updated>2012-11-19T12:36:33+09:00</updated>
  <id>http://rumidier.github.com/</id>
  <author>
    <name><![CDATA[rumidier]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Side-function]]></title>
    <link href="http://rumidier.github.com/blog/2012/07/12/side-function/"/>
    <updated>2012-07-12T14:03:00+09:00</updated>
    <id>http://rumidier.github.com/blog/2012/07/12/side-function</id>
    <content type="html"><![CDATA[<h2>Action - approval, refuse</h2>

<p><a href="https://gist.github.com/3096325">approval</a></p>

<p><a href="https://gist.github.com/3096321">refuse</a></p>

<p>Approval은 청구 목록에 대하여 승인 기능을
refuse는 청구 목렉에 대하여 거부 기능을 가지게 된다.</p>

<p>승인 기능은 두가지 상황에서 선택 할수 있게 된다.
/list/view/user_num과 전체 list상태, 대기 리스트 상태, 거부 리스트 상태
에서 활성화가 되고 action을 취할수 있게 한다.</p>

<p>거부 기능은 두가지 상황에서 선택 할수 있게 된다.
/list/view/user_num과 전체 list상태, 대기 리스트 상태, 승인 리스트 상태
에서 활성화가 되고 action 을 취할수 있게 한다.</p>

<p>/list/view/user_id</p>

<p>아래와 같이 id 값과 함께 전달 할수 있다.</p>

<pre><code>&lt;a href="[% c.uri_for('/list/approval', charge.id) %]" class="btn btn-primary"&gt;승인&lt;/a&gt;
&lt;a href="[% c.uri_for('/list/refuse', charge.id) %]" class="btn btn-primary"&gt;거부&lt;/a&gt;
</code></pre>

<p>CaputreArgs(1) 옵션으로 $id 값(들)을 받을수 있게 된다.</p>

<pre><code>sub approval :Local :CaptureArgs(1) {
    my ( $self, $c, $id ) = @_;
    my @target_ids = split ',', $id;

sub refuse :Local :CaptureArgs(1) {
my ( $self, $c, $id ) = @_;
my @target_ids = split ',', $id;
</code></pre>

<p>@target_id의 모든 값(들)을 status값이 2 or 3로 업데이트 한다.
업데이트는 검색을 한 값들을 대상으로 update를 하게 된다.</p>

<pre><code>$ vi root/templates/default/src/list

# 승인
my $approval = $c-&gt;model('MyApp_DB')-&gt;resultset('Charge')-&gt;search({ id =&gt; { -in
        =&gt; \@target_ids } })-&gt;update_all({ status =&gt; '2' });
# 거부
my $refuse = $c-&gt;model('MyApp_DB')-&gt;resultset('Charge')-&gt;search({ id =&gt; { -in
        =&gt; \@target_ids } })-&gt;update_all({ status =&gt; '3' });
</code></pre>

<p>flash기능으로 messages값을 전달하여 조건에 맞을시 메세지를 출력 시키도록 한다.(/list/index.tt 참고)
조건은 approval, refuse기능이 정상 작동 되었는지를 검사 하게 된다.</p>

<pre><code>if ($query_status) {
    $c-&gt;flash-&gt;{messages} = 'Success message.';
}
else {
    $c-&gt;flash-&gt;{messages} = 'No status Item.';
}
</code></pre>

<p>템플릿에 쓰일 status값과 함께 전체 목록으로 redirect 시키도록 한다.</p>

<pre><code>$c-&gt;stash-&gt;{status} = '2'; #상태에 맞는 status값
$c-&gt;res-&gt;redirect($c-&gt;uri_for('/list'));
</code></pre>

<h2>Action - delete</h2>

<p><a href="https://gist.github.com/3096329">delete</a></p>

<p>승인 기능은 두가지 상황에서 선택 할수 있게 된다.
/list/view/user_num과 전체 list상태, 대기, 거부, 수정 상태
 에서 활성화가 되고 action을 취할수 있게 한다.</p>

<pre><code>$ vi root/templates/default/src/list
&lt;a href="[% c.uri_for('/list/delete', charge.id) %]" class="btn btn-primary"&gt;삭제&lt;/a&gt;
</code></pre>

<p>다른 기능과 같이 CaptureArgs(1)를 받는다.</p>

<pre><code>sub delete :Local :CaptureArgs(1) {
my ( $self, $c, $id ) = @_;
my @target_ids = split ',', $id;
</code></pre>

<p>다른 기능과 달리 update_all 이 아닌 delete_all를 통하여 내용을 삭제 한다.</p>

<pre><code>my $charge = $c-&gt;model('DonDB')-&gt;resultset('Charge')-&gt;search({ id =&gt; { -in =&gt; \@target_ids } })-&gt;delete_all;
</code></pre>

<h2>CPAN</h2>

<p><a href="https://metacpan.org/module/DBIx::Class::Manual::DocMap">DBIx::Class::Manual::DocMap</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[list-edit]]></title>
    <link href="http://rumidier.github.com/blog/2012/07/12/list-edit/"/>
    <updated>2012-07-12T13:56:00+09:00</updated>
    <id>http://rumidier.github.com/blog/2012/07/12/list-edit</id>
    <content type="html"><![CDATA[<h2>청구 내역 수정</h2>

<p><a href="https://gist.github.com/3095912">List-edit-action</a></p>

<p>수정 되어야할 $edit_id를 받을수 있어햐 한다.</p>

<pre><code>sub edit :Local :CaptureArgs(1) {
my ( $self, $c, $edit_id ) = @_;
</code></pre>

<p>수정할 폼을 제출 했을때 업데이트 동작 혹은 정보 출력을 하여야 한다.</p>

<pre><code>if ($c-&gt;req-&gt;method eq 'POST') {
    my @messages;

    push @messages, 'amount is invaild' if ($c-&gt;req-&gt;params-&gt;{amount} !~ /^\d+$/);
    push @messages, 'title is required' unless ($c-&gt;req-&gt;params-&gt;{title});

    if (@messages) {
    $c-&gt;flash(
        messages =&gt; @messages,
        comment  =&gt; $c-&gt;req-&gt;params-&gt;{comment},
        title    =&gt; $c-&gt;req-&gt;params-&gt;{title},
        amount   =&gt; $c-&gt;req-&gt;params-&gt;{amount},
    );

    return $c-&gt;res-&gt;redirect($c-&gt;uri_for("/list/view/$c-&gt;req-&gt;params-&gt;{charge_id}"));
    }

    my $time = strftime "%Y-%m-%d %H:%M:%S", localtime;
    my %row = (
    id         =&gt; $c-&gt;req-&gt;params-&gt;{charge_id},
    amount     =&gt; $c-&gt;req-&gt;params-&gt;{amount},
    user       =&gt; $c-&gt;req-&gt;params-&gt;{charge_user},
    title      =&gt; $c-&gt;req-&gt;params-&gt;{title},
    comment    =&gt; $c-&gt;req-&gt;params-&gt;{comment},
    updated_on =&gt; "$time",
    );
    $c-&gt;model('DonDB')-&gt;resultset('Charge')-&gt;update_or_create(\%row);

    $c-&gt;res-&gt;redirect($c-&gt;uri_for("/list/view/$row{id}"));
}
else {
    my $editer = $c-&gt;model('DonDB')-&gt;resultset('Charge')-&gt;find($edit_id);

    $c-&gt;stash(
    editer =&gt; $editer,
    );
}
}
</code></pre>

<p><a href="https://gist.github.com/3095922">List-edit.tt</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[list-write]]></title>
    <link href="http://rumidier.github.com/blog/2012/07/12/list-write/"/>
    <updated>2012-07-12T13:49:00+09:00</updated>
    <id>http://rumidier.github.com/blog/2012/07/12/list-write</id>
    <content type="html"><![CDATA[<p><a href="https://gist.github.com/3095879">List-write.tt</a>
<a href="https://gist.github.com/3095901">List-write-action</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[list-view]]></title>
    <link href="http://rumidier.github.com/blog/2012/07/12/list-view/"/>
    <updated>2012-07-12T13:41:00+09:00</updated>
    <id>http://rumidier.github.com/blog/2012/07/12/list-view</id>
    <content type="html"><![CDATA[<p><a href="https://gist.github.com/3095846">List-view-action</a>
<a href="https://gist.github.com/3095858">List-view.tt</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[list]]></title>
    <link href="http://rumidier.github.com/blog/2012/07/11/list/"/>
    <updated>2012-07-11T23:06:00+09:00</updated>
    <id>http://rumidier.github.com/blog/2012/07/11/list</id>
    <content type="html"><![CDATA[<h2>청구 목록 페이지</h2>

<p><a href="https://gist.github.com/3095682">List.pm - index</a></p>

<p><a href="https://gist.github.com/3095679">/list/index.tt</a></p>

<h2>List Controller - Query option</h2>

<p>등록 날짜 역순 출력을 위한 내림 차수 옵션을 준다.</p>

<pre><code>my %attr  = ( 'order_by' =&gt; { -desc =&gt; 'me.id' } );

my $total_charge;
my %cond    = ();
</code></pre>

<p>현재 가르켜야 할 페이지 정보가 없다면 1페이지로 하게 한다.</p>

<pre><code>my $page    = $c-&gt;req-&gt;params-&gt;{page};
$attr{page} = $page || 1;
</code></pre>

<p>status 옵션이 정의 되지 않았다면 전체(대기/승인/거부) 검색을 할수 있게 한다.</p>

<pre><code>my $status  = $c-&gt;req-&gt;param("status") || $c-&gt;stash-&gt;{"status"} || '0'; #수정 필요
</code></pre>

<p>status 옵션 없으면 전체 있으면 상태 검색 할수 있게 한다.</p>

<pre><code>%cond         = ( status =&gt; $status ) if $status;
$total_charge = $c-&gt;model('DonDB')-&gt;resultset('Charge')-&gt;search(\%cond, \%attr);
</code></pre>

<p>Data::Pageset활용 하여 페이징 할수 있다.</p>

<pre><code>my $page_info =
Data::Pageset-&gt;new(
    {
    ( map { $_ =&gt; $total_charge-&gt;pager-&gt;$_ } qw/entries_per_page total_entries current_page/ ),
    mode =&gt; "slide",
    pages_per_set =&gt; 10,
    }
);

$c-&gt;stash(
    lists   =&gt; [ $total_charge-&gt;all ],
    status  =&gt; $status,
    pageset =&gt; $page_info,
);
}
</code></pre>

<h2>List - View</h2>

<p>성공 혹은 실패 메세지 출력을 할수 있게 한다.</p>

<pre><code>[% IF messages %]
&lt;div class="alert fade in"&gt;
&lt;button class="close" data-dismiss="alert"&gt;&amp;times;&lt;/button&gt;
[% messages %]
&lt;/div&gt;
[% END %]
</code></pre>

<p>탭 등록으로 원하는 상태의 값들만 보여 줄수 있게 한다.</p>

<pre><code>&lt;div class="container-fluid"&gt;
  &lt;div class="row-fluid"&gt;
&lt;div class="span2"&gt;
  &lt;ul class="nav nav-tabs nav-stacked"&gt;
    &lt;li class="active"&gt;&lt;a href="http://rumidier.github.com/list"&gt;전체&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="http://rumidier.github.com/list?status=1"&gt;대기&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="http://rumidier.github.com/list?status=2"&gt;승인&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="http://rumidier.github.com/list?status=3"&gt;거부&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre>

<p>현재 경로가 어떻게 되는지 확인 할수 있도록 한다.</p>

<pre><code>&lt;div class="span10"&gt;
  &lt;ul class="breadcrumb"&gt;
    &lt;li&gt;목록
        &lt;span class="divider"&gt;/&lt;/span&gt;
    &lt;/li&gt;      
    &lt;li class="active"&gt;
    [% IF status == "1" %]
        &lt;b&gt; 대기 &lt;/b&gt;
    [% ELSIF status == "2" %]
        &lt;b&gt; 승인 &lt;/b&gt;
    [% ELSIF status == "3" %]
        &lt;b&gt; 거부 &lt;/b&gt;
    [% ELSE %]
        &lt;b&gt; 전체 &lt;/b&gt;
    [% END %]     
    &lt;/li&gt;
  &lt;/ul&gt;
</code></pre>

<h2>CPAN</h2>

<p><a href="https://metacpan.org/module/Data::Pageset">Data::Pageset</a></p>

<p><a href="https://metacpan.org/module/DBIx::Class::Manual::DocMap">DBIx::Class::Manual::DocMap</a></p>
]]></content>
  </entry>
  
</feed>
